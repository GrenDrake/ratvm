# RatVM

RatVM is a virtual machine designed for creating and playing CYOA-style adventure games. This repository contains the standard compiler as well as a console-based interpreter. A JavaScript-based interpreter is also available under the [PlayRat repository](https://github.com/GrenDrake/playrat) and it is recommended to use that one for regular play.

## Dependencies

[utf8proc](https://github.com/JuliaStrings/utf8proc/) is used to handle normalization and manipulation of Unicode strings.

[SQLite3](https://sqlite.org/) is used by the runner to contain the virtual file system presented to running games.

## Usage

All programs contained in this repository are intended to be executed via the command line.

### Compiler

The compiler is executed in the form of:

```
./build [options] [source files]
```

At least one source file must be specified. If the program uses multiple source files, they must all be specified. By default, the compiler will produce a file named `game.rvm`, but the `-o` option may be used to specify an alternative name.

Several options exist for the compiler, most of which produce output intended for use in debugging the compiler itself and will likely be of little use to game authors.

#### General Use Options

**-color**: Force use of colour in compiler output.

**-no-color**: Disable use of colour in compiler output.

**-show-files**: Displays name of files as they are read.

**-show-next-ident**: Shows the next available unused value for object's `$ident` property.

**-skip-ident-check**: Disable check ensuring no objects share the same value in their `$ident` property.

**-o [file path]**: Specifies the file path that the compiler's output is written to.

#### Compiler Debug Options

**-asm**: Dumps final assembly code for all functions to `asm.txt`.

**-bytecode**: Dumps hex-encoded dump of function bytecode with function headers to `functions.txt`.

**-data**: Dumps game file TOC, property numbers, lists, maps, objects, and symbol table to `data.txt`.

**-full-bytecode**: Produces hex dump of full game bytecode to `bytecode.txt`.

**-functions**: Dumps function header data to `functions.txt`.

**-ir**: Dumps intermediate representation code for non-assembly functions to `ir.txt`.

**-strings**: Dump all game strings to the file `strings.txt`.

**-tokens**: Dumps all tokens generated by lexing the source files to `tokens.txt`.

### Interpreter

The interpreter is executed as:

```
./run [options] [game file]
```


If no game file is specified, the interpreter will attempt to load `game.bin` from the current directory and will fail if it cannot be loaded.

#### Interpreter Options

**-v**: Display interpreter version and exit.

**-debug**: Display opcodes executed and garbage collection information at each input event.

**-dump**: Dump game data to text file and exit.

**-silent**: Run game file until first input (or until complete) then exit; do not display game output.

## License

The RatVM compiler and interpreter contained in this repository are made available under the terms of the [GPL 3.0 license](LICENSE).
